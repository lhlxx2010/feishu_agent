name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 手动触发（用于集成测试）
  issue_comment:
    types: [ created ]
  pull_request_review_comment:
    types: [ created ]

jobs:
  test:
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    env:
      LARK_APP_ID: cli_dummy_id
      LARK_APP_SECRET: dummy_secret
      FEISHU_PROJECT_USER_TOKEN: dummy_token
      FEISHU_PROJECT_USER_KEY: dummy_user

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.11"

      - name: Install dependencies
        run: uv sync

      - name: Run tests
        run: uv run pytest tests/unit -v

  integration-test:
    # 集成测试 - 手动触发或主分支推送
    # 注意：需要 Repository Secrets 配置了 FEISHU_TEST_PROJECT_KEY 等变量，否则测试会被跳过
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    env:
      LARK_APP_ID: ${{ secrets.LARK_APP_ID }}
      LARK_APP_SECRET: ${{ secrets.LARK_APP_SECRET }}
      FEISHU_PROJECT_PLUGIN_ID: ${{ secrets.FEISHU_PROJECT_PLUGIN_ID }}
      FEISHU_PROJECT_PLUGIN_SECRET: ${{ secrets.FEISHU_PROJECT_PLUGIN_SECRET }}
      FEISHU_PROJECT_USER_KEY: ${{ secrets.FEISHU_PROJECT_USER_KEY }}
      FEISHU_TEST_PROJECT_KEY: ${{ secrets.FEISHU_TEST_PROJECT_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.11"

      - name: Install dependencies
        run: uv sync

      - name: Run integration tests
        run: uv run pytest tests/integration -v -m integration

  build:
    needs: test
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.11"

      - name: Install dependencies
        run: uv sync

      - name: Build package
        run: |
          # 清理旧的构建文件
          rm -rf dist/ build/ *.egg-info
          # 构建 wheel 和 sdist
          uv build

      - name: Verify build artifacts
        run: |
          echo "Build artifacts:"
          ls -lh dist/
          echo ""
          echo "Verifying wheel package..."
          python -m zipfile -l dist/*.whl | head -10
          echo ""
          echo "Verifying entry points..."
          unzip -p dist/*.whl */dist-info/entry_points.txt || true

      - name: Test installation
        env:
          LARK_APP_ID: test_app_id
          LARK_APP_SECRET: test_app_secret
          FEISHU_PROJECT_USER_TOKEN: test_token
          FEISHU_PROJECT_USER_KEY: test_user_key
        run: |
          # 测试 wheel 包是否可以正常安装
          uv tool install dist/*.whl --force
          # 验证命令是否可用（uv tool install 会将命令安装到 ~/.local/bin）
          export PATH="$HOME/.local/bin:$PATH"
          if command -v lark-agent &> /dev/null; then
            echo "✓ lark-agent command found: $(which lark-agent)"
          else
            echo "⚠ lark-agent command not found in PATH, but installation succeeded"
          fi
          # 验证模块是否可以导入（需要环境变量）
          python -c "from src.mcp_server import main, mcp; print('✓ Module import successful')"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-packages
          path: dist/*
          retention-days: 30

      - name: Upload to GitHub Releases
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  opencode:
    if: |
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      (contains(github.event.comment.body, ' /oc') ||
       startsWith(github.event.comment.body, '/oc') ||
       contains(github.event.comment.body, ' /opencode') ||
       startsWith(github.event.comment.body, '/opencode'))
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: read
      issues: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run opencode
        uses: anomalyco/opencode/github@latest
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          model: deepseek/deepseek-reasoner
