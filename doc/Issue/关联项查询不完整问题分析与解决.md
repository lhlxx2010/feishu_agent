# 关联项查询不完整问题分析与解决报告

## 1. 问题描述
用户反馈在查询与 **SG06VA1** (ID: 6288163810) 关联的 **Issue管理** 工作项时，lark MCP 工具最初只返回了 3 个结果，而实际在飞书系统中通过“关联项目”筛选应该有 **33 个**结果。

典型遗漏案例：工作项 `6273025176` (名称: "V067 Q2 SDK产品工程搭建") 未能被查询到。

---

## 2. 问题分析

### 2.1 原始查询逻辑的局限性
1. **关键词搜索的局限**:
   - 最初尝试通过 `name_keyword="SG06VA"` 搜索，由于部分关联项（如 `6273025176`）的标题中并不包含 "SG06VA" 字符串，导致被过滤。
2. **`related_to` 参数实现的缺陷**:
   - 原始逻辑在处理 `related_to` 参数时，仅调用了一次 `filter` API 并获取了第一页数据（默认 50 条）。
   - 该空间共有 1131 个 Issue，而 33 个关联项分散在不同的分页中。
3. **API 过滤能力的限制**:
   - 飞书 Project API 的 `filter` 和 `search/params` 接口**不支持**直接按关联工作项字段（如 `field_3bf6c0`）进行服务端过滤。
   - 这意味着必须在客户端获取数据后进行逻辑判断。

### 2.2 数据结构验证
通过查询工作项 `6273025176` 的原始 JSON 发现：
- 其关联项目存储在 `field_3bf6c0` 字段中。
- 值为 `[6288163810]`，正是目标项目的 ID。
- 标题确实不包含项目关键字，验证了“名称搜索”方案的不可靠性。

---

## 3. 解决方案

针对上述分析，对 `WorkItemProvider.get_tasks` 方法进行了重构，引入了**全量扫描+客户端过滤**的策略。

### 3.1 核心修复逻辑
当用户仅提供 `related_to` 参数（且没有关键词、状态、优先级等服务端可过滤条件）时，执行以下流程：

1. **自动分页获取**:
   - 实现 `while True` 循环，自动请求后续页码。
   - 设置 `page_size=100`（API 允许的最大值）以减少请求次数。
2. **全量数据扫描**:
   - 获取所有工作项（当前设置了 20 页/2000 条记录的安全上限，足以覆盖该空间的 1131 条数据）。
3. **深度字段检查**:
   - 遍历每个工作项的 `fields` 列表。
   - 检查 `field_value` 是否匹配目标 ID。
   - 支持处理“列表”格式（多选关联）和“单值”格式。
4. **结果聚合**:
   - 将所有匹配的项汇总并返回。

### 3.2 代码修改位置
- 文件: `src/providers/project/work_item_provider.py`
- 方法: `get_tasks`

---

## 4. 验证结果

### 4.1 自动化测试验证
编写并运行了 `tmp/test_related_filter.py` 脚本：
- **目标 ID**: 6288163810 (SG06VA1)
- **查询结果**: 成功找到 **33 个**关联的工作项。
- **特定项确认**: 确认包含了工作项 `6273025176` ("V067 Q2 SDK产品工程搭建")。

### 4.2 修复效果对照

| 查询方式 | 修复前结果 | 修复后结果 | 结论 |
| :--- | :--- | :--- | :--- |
| 名称搜索 ("SG06VA") | 25 个 | 25 个 | 遗漏名称不含关键字的项 |
| 关联项搜索 (related_to) | 3 个 | **33 个** | **完全符合系统实际数据** |

---

## 5. 后续建议
1. **重启服务**: 修改后的代码需要重启 MCP 服务器才能生效。
2. **性能优化**: 对于数据量超过 2000 条的空间，可能需要进一步调优扫描策略。
3. **API 关注**: 持续关注飞书官方是否开放关联字段的服务端搜索能力，以替代当前的客户端过滤方案。

---
**文档版本**: 1.0.0
**日期**: 2026-01-14
**状态**: 已解决 (Resolved)
